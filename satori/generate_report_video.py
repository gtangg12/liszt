import os
import datetime
import cv2
from PIL import Image

#from nlp import scrape_daily_news, load_articles, generate_report_text
from audio import synthesize_text
from animation import generate_unsynced_video, load_avatar_image

import numpy as np
import ffmpeg


def combine(output_dir):
    audio_path = f'{output_dir}/audio.mp3'
    video_path = f'{output_dir}/video.mp4'
    audio = ffmpeg.input(audio_path)
    video = ffmpeg.input(video_path)
    ffmpeg.output(audio, video, f'{output_dir}/combined.mp4').run()


def main():
    date_str = datetime.datetime.now().strftime('%Y-%m-%d')
    output_path = f'data/{date_str}'
    os.makedirs(output_path, exist_ok=True)

    #scrape_daily_news(output_path)
    #articles = load_articles(f'{output_path}/news.json')
    #text = generate_report_text(articles)
    #print(text)  
    text = ['Nearly all the Republicans vying for the party Senate nomination in Ohio are embracing former President Donald Trump message . That prospect is the nightmare of national Republicans, who are watching as similar potential scenarios loom across the Senate playing field . On Wednesday night, the singers concert in Evansville, Ind., began with video greeting from the 45th president, which has now been viewed more than half million times on TikTok . Kid Rock launched into performance of his obscenity laced new song, We The People, whose lyrics are filled with partisan rage directed at supporters of the Black Lives Matter movement; people who wear masks to prevent the spread of covid 19; the mainstream media .', 'Dwayne Haskins, 24, was expected to compete for the starting job with Mason Rudolph and Mitchell Trubisky in training camp . The Bullis School in Potomac, Md, where he was high school star, posted community bulletin that began, It is with profound sadness and Patrick Cilento, who coached him there from 2013 to 2016, said in an interview that he was great kid, great person . Haskin had history of making poor decisions, such as leaving Ohio State year early despite experts advising him not to, as well as choosing to host his own NFL draft party rather than accept an invite from the league .', 'Power has been restored to 90 percent of Puerto Rico, according to the islands power operator . More than 200,000 residents remained without electricity on Saturday, three days after the outage began . This is the future look of the American West, said Chris Hanley, the producer of the movies American Psycho and Spring Breakers, who owns the Invisible House, a rectangular prism covered in mirrored glass that disappears into the landscape when viewed from the right angle . Marcus Johansson had felt at home for weeks after rejoining Washington at the trade deadline he had previously played for the Capitals from 2010 to 2017 but he was still looking for breakthrough with his first goal in his return .', "Former President Donald Trump endorsed Dr Mehmet Oz for US Senate on Saturday . The former star of The Dr Oz Show has been attacked by rivals as closet liberal . The Republican Senate primary in Pennsylvania is a tight race for the former president's backing in the state . The endorsement comes just weeks before the Republican primary for the US Senate in Pennsylvania, where the leading candidates have jockeyed for Trumps support in a tight contest for the Republican nomination for the U.S. Senate . The final vote will be held in November's final presidential election on November 11 . The Pennsylvania primary is a hotly contested Republican primary in which the candidates are vying for votes of up to 60 votes .", 'UK to send 120 armored vehicles and anti-ship missile systems to Ukraine . Boris Johnson and Volodymyr Zelensky hold talks in Kyiv . EU delegation in Ukraine returns to Kyiv after being temporarily relocated to Poland . US official says Russia has appointed general with extensive experience in Syria and the Donbas to oversee the war effort . EU Commission President Ursula von der Leyen made trip to the Ukrainian capital city to offer support and speak with Zelenskoyy about bloc membership . EU flag returned to the capital city of Kyiv, signaling his return to the city after the Russian invasion of Ukraine . The EU flag was temporarily moved to Poland during the invasion .', 'Trump Jr was pushing for several strategies -- from pressing state legislators to put forward slates of fake "Trump electors," to firing the FBI Director and replacing him with loyalist who would do Trump bidding . The level of preparation and dogged determination within Trump inner circle to keep him in power, no matter the outcome of the election . Of course, President Trump started lying about the specter of election fraud in the spring of 2020 -- an insurance policy he likely planted because he was trailing in the polls and desperately feared losing . Just last week, US District Court Judge David Carter wrote an opinion in response to Trump former lawyer John Eastman, who asked the judge to withhold certain documents requested by the House select committee .', 'The owner of Lock Stock Barrel Shooting Range in Grantville, Georgia, was found dead along with his wife and grandson . The Georgia Bureau of Investigation and the federal Bureau of Alcohol, Tobacco, Firearms and Explosives are investigating the crime . The owner and his grandson were found dead at the shooting range on Friday . The suspect and his wife were killed in a robbery at the gun range, police said . The shooting occurred at a gun range in the town of Grantville on Friday night, killing three people, including the owner of the range and his grandchild, according to police . The suspects are still at large in the case .', 'The Russians became desperate when it became clear they wouldnt be able to move on Kyiv, says Sergei Radetskiy . There is body in the basement of the abandoned yellow home at the end of the street near the railroad tracks . Some believe the house to house targeting of younger men was hunt for those who had fought the Russians in recent years in separatist held eastern Ukraine and had been given shelter in the town . As she stood there, crying, Russian soldier told her not to be afraid, they only wanted to speak with men, she says . Some residents were told to stand near the bodies of several men who had been killed, some with their hands bound .', 'Scottie Scheffler has three shot advantage over Cameron Smith . Firefighters in Northern California working to put out four alarm fire near the port in Benicia, about 40 miles northeast of San Francisco . Cameron Smith surged up the leaderboard with his own excellent round of 68 on Saturday . The previous four players to take such lead Herman Kaiser, Jack Nicklaus, Raymond Floyd and Jordan Spieth all went on to win the green jacket at the Masters Tournament in 2004 . The Masters record for the biggest 36 hole lead after brilliant second round is tied with the previous four who have taken such a lead in the tournament since Herman Kaiser was the only player to do so .', 'Dominic Taddeo was in his early 20s when US Justice Department lawyer appeared before Senate subcommittee with dire warning about the future mafia hit man hometown . "This guy has delusions of grandeur," host of the Gangland Wire Crime Stories podcast says . After Lelko showed police on August 26 where the bodies were buried, Lyons Police Department officers and Cook County Medical Examiners went to the location and "unearthed large plastic containers," court documents say . In meeting last summer, officials from the Centers for Disease Control and Prevention told Mr Bidens top aides that it was not clear there was still public health rationale for keeping the border shut to most migrants .', "Pakistani Prime Minister Imran Khan was voted out of office early Sunday morning . Pakistan's political opposition ousted the countrys embattled prime minister in no confidence vote . The largest among the opposition parties the Pakistan Peoples Party, led by the son of slain former Prime Minister Benazir Bhutto, and the Pakistan Muslim League have been tainted by allegations of widespread corruption . A 26-year-old woman in Texas was arrested and charged with murder after what authorities claimed was self induced abortion, the Associated Press reported Saturday . The woman is accused of killing her husband and inviting the Taliban to join the Taliban takeover in Afghanistan last year . He also traveled to Moscow to meet with Putin on the eve of the invasion of Ukraine .", "A Michigan dog having tough time at shelter now has his own private castle pink princess themed tent . Hidden spaces can help alleviate stress for shelter animals, since they can block out the goings on around them and help them feel protected . Heart Dogs announced this week that it will be collecting new and used kid tents for other animals in the shelter, too . The princess tent has brought Starsky a lot of attention, including on social media and via the Today show, and Heart Dogs is thrilled he has so much support . The organization is also hoping to collect other animal shelters' old and used tents for the shelter's other animals too ."]
    
    #text = "Its clear Kid Rock knows his audience and so, apparently, does Donald Trump. On Wednesday night, the singers concert in Evansville, Ind, began with video greeting from the 45th president, which has now been viewed more than half million times on TikTok Flanked by American flags, Trump appeared full of affection both for concertgoers and for Rock, whom he referred to by the singers given name, Bob Immediately after the video ended, Kid Rock launched into performance of his obscenity laced new song, We The People, whose lyrics are filled with partisan rage directed at supporters of the Black Lives Matter movement; people who wear masks to prevent the spread of covid 19; the mainstream media; Anthony Fauci; and using the phrase Lets go, Brandon President Biden, among others."
    #times = synthesize_text([c['text'] for c in text], f'{output_path}/audio.mp3')
    subvideos = synthesize_text(text, f'{output_path}')
    current_par = 0
    for i,times in enumerate(subvideos):
        #assert len(times) == len(text)
        avatar_image = load_avatar_image('talkinghead/avatar_images/reporter_male.png')
        background_image = cv2.resize(np.array(Image.open('data/cityscape.jpg')) / 255, (256,256))
        generate_unsynced_video(avatar_image, f'{output_path}/{i}/video.mp4', f'{output_path}/{i}/audio.mp3', background_image)#, times, [None for c in text])#[c['image'] for c in text])
        combine(f'{output_path}/{i}')


if __name__ == '__main__':
    main()
    #scrape_daily_news(output_path)
    #articles = load_articles(f'{output_path}/news.json')
    #text = generate_report_text(articles)
